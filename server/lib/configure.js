"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.configure = exports.defaultOptions = void 0;
const fs_1 = __importDefault(require("fs"));
const path_1 = __importDefault(require("path"));
const logger_1 = __importDefault(require("@moderno/logger"));
function loadConfig(pathname) {
    try {
        let config = require(path_1.default.resolve(pathname));
        if (config.extends) {
            const base = config.extends;
            delete config.extends;
            config = assignConfig(base, config);
        }
        return config;
    }
    catch (error) {
        logger_1.default.error(`Unable to load config '${pathname}' from '${process.cwd()}'\n`, error);
        process.exit(1);
    }
}
function resolveConfig(pathname) {
    try {
        return require.resolve(path_1.default.resolve(pathname));
    }
    catch (ignored) {
        return null;
    }
}
function assignConfig(target, source) {
    if (source !== undefined && source !== null) {
        if (target instanceof Array && source instanceof Array) {
            const merged = new Set(target);
            for (const item of source) {
                merged.add(item);
            }
            target.length = 0;
            target.push(...merged);
        }
        else if (target instanceof Object && source instanceof Object) {
            for (const [k, v] of Object.entries(source)) {
                if (target[k] && (v.constructor === Object || v.constructor === Array)) {
                    assignConfig(target[k], v);
                }
                else {
                    target[k] = v;
                }
            }
        }
    }
}
function statDirectory(pathname) {
    try {
        return fs_1.default.statSync(pathname);
    }
    catch (ignored) {
        throw new Error(`ENOENT: no such file or directory '${pathname}'`);
    }
}
function resolveDirectory(name) {
    const pathname = path_1.default.resolve(name);
    if (!statDirectory(pathname).isDirectory()) {
        throw new Error(`ENODIR: not a directory '${pathname}'`);
    }
    return pathname;
}
function defaultOptions(args) {
    const baseDir = path_1.default.resolve(__dirname, "..");
    const rootDir = args.root ? resolveDirectory(args.root) : process.cwd();
    const readTextFileSync = (filename) => {
        try {
            return fs_1.default.readFileSync(path_1.default.resolve(rootDir, filename), "utf-8");
        }
        catch (ignored) {
            return fs_1.default.readFileSync(path_1.default.resolve(baseDir, filename), "utf-8");
        }
    };
    return Object.assign({
        rootDir,
        log: {
            level: "info"
        },
        http2: "push",
        server: {
            protocol: "https",
            host: "localhost",
            port: 3000,
            options: {
                get key() {
                    return readTextFileSync("cert/localhost.key");
                },
                get cert() {
                    return readTextFileSync("cert/localhost.crt");
                },
                allowHTTP1: true
            }
        },
        resources: path_1.default.resolve(baseDir, "resources"),
        watcher: {
            cwd: rootDir,
            atomic: false,
            ignored: [
                "node_modules/**",
                "web_modules/**"
            ]
        },
        router: {
            ignoreTrailingSlash: true,
            allowUnsafeRegex: true
        },
        middleware: [],
        proxy: {
            "/api": { target: "http://localhost:9000" }
        },
        cors: {
            origin: "*",
            methods: "GET, HEAD, PUT, POST, DELETE, PATCH",
            allowedHeaders: "X-Requested-With, Accept, Content-Type",
            credentials: true
        },
        cache: true,
        deflate: true,
        etag: {
            weak: false
        },
        mount: {
            "/": rootDir
        },
        babel: {
            babelrc: true,
            caller: {
                name: "@moderno/server",
                supportsStaticESM: true
            },
            sourceType: "module",
            sourceMaps: true,
            plugins: [
                ["@babel/plugin-syntax-import-meta"],
                ["@babel/plugin-transform-runtime", {
                        "corejs": false,
                        "helpers": true,
                        "regenerator": false,
                        "useESModules": true,
                        "absoluteRuntime": false,
                        "version": "7.10.5"
                    }]
            ]
        },
        sass: {
            extensions: [".scss", ".css", ".sass"],
            outputStyle: "expanded",
            HMR: true
        }
    }, require("@moderno/web-modules/web-modules.config.js"));
}
exports.defaultOptions = defaultOptions;
function configure(args = {}, override) {
    let options = defaultOptions(args);
    if (args.config) {
        assignConfig(options, loadConfig(args.config));
    }
    else {
        const rootConfig = resolveConfig(path_1.default.join(options.rootDir, "moderno.config"));
        const localConfig = resolveConfig("moderno.config");
        if (rootConfig) {
            if (localConfig !== rootConfig) {
                assignConfig(options, loadConfig(rootConfig));
            }
        }
        else {
            logger_1.default.debug(`no config found in '${options.rootDir}'`);
        }
        if (localConfig) {
            assignConfig(options, loadConfig(localConfig));
        }
        else {
            logger_1.default.debug(`no config found in '${process.cwd()}'`);
        }
    }
    if (override) {
        assignConfig(options, override);
    }
    const plugins = options.plugins || [];
    if (args.plugin) {
        const names = Array.isArray(args.plugin) ? args.plugin : [args.plugin];
        for (const name of names)
            try {
                plugins.push(require.resolve(name, { paths: [options.rootDir] }));
            }
            catch (error) {
                try {
                    plugins.push(require.resolve(name, { paths: [__dirname] }));
                }
                catch (error) {
                    logger_1.default.error("plugin '" + name + "' resolution failed:", error);
                    process.exit(1);
                }
            }
    }
    for (let plugin of plugins)
        try {
            if (typeof plugin === "string") {
                plugin = require(plugin);
            }
            if (plugin.extends) {
                assignConfig(plugin.extends, plugin);
                plugin = plugin.extends;
                delete plugin.extends;
            }
            assignConfig(options, plugin);
        }
        catch (error) {
            logger_1.default.error("plugin '" + plugin + "' loading failed:", error);
            process.exit(1);
        }
    if (options.log) {
        Object.assign(logger_1.default, options.log);
    }
    if (args.debug) {
        logger_1.default.level = "debug";
    }
    logger_1.default.debug("configured:", options);
    return options;
}
exports.configure = configure;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY29uZmlndXJlLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vc3JjL2NvbmZpZ3VyZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7QUFNQSw0Q0FBb0I7QUFHcEIsZ0RBQXdCO0FBQ3hCLDZEQUFrQztBQXlDbEMsU0FBUyxVQUFVLENBQUMsUUFBZ0I7SUFDaEMsSUFBSTtRQUNBLElBQUksTUFBTSxHQUFHLE9BQU8sQ0FBQyxjQUFJLENBQUMsT0FBTyxDQUFDLFFBQVEsQ0FBQyxDQUFDLENBQUM7UUFDN0MsSUFBSSxNQUFNLENBQUMsT0FBTyxFQUFFO1lBQ2hCLE1BQU0sSUFBSSxHQUFHLE1BQU0sQ0FBQyxPQUFPLENBQUM7WUFDNUIsT0FBTyxNQUFNLENBQUMsT0FBTyxDQUFDO1lBQ3RCLE1BQU0sR0FBRyxZQUFZLENBQUMsSUFBSSxFQUFFLE1BQU0sQ0FBQyxDQUFDO1NBQ3ZDO1FBQ0QsT0FBTyxNQUFNLENBQUM7S0FDakI7SUFBQyxPQUFPLEtBQUssRUFBRTtRQUNaLGdCQUFHLENBQUMsS0FBSyxDQUFDLDBCQUEwQixRQUFRLFdBQVcsT0FBTyxDQUFDLEdBQUcsRUFBRSxLQUFLLEVBQUUsS0FBSyxDQUFDLENBQUM7UUFDbEYsT0FBTyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQztLQUNuQjtBQUNMLENBQUM7QUFFRCxTQUFTLGFBQWEsQ0FBQyxRQUFnQjtJQUNuQyxJQUFJO1FBQ0EsT0FBTyxPQUFPLENBQUMsT0FBTyxDQUFDLGNBQUksQ0FBQyxPQUFPLENBQUMsUUFBUSxDQUFDLENBQUMsQ0FBQztLQUNsRDtJQUFDLE9BQU8sT0FBTyxFQUFFO1FBQ2QsT0FBTyxJQUFJLENBQUM7S0FDZjtBQUNMLENBQUM7QUFFRCxTQUFTLFlBQVksQ0FBSSxNQUFTLEVBQUUsTUFBVztJQUMzQyxJQUFJLE1BQU0sS0FBSyxTQUFTLElBQUksTUFBTSxLQUFLLElBQUksRUFBRTtRQUN6QyxJQUFJLE1BQU0sWUFBWSxLQUFLLElBQUksTUFBTSxZQUFZLEtBQUssRUFBRTtZQUNwRCxNQUFNLE1BQU0sR0FBRyxJQUFJLEdBQUcsQ0FBQyxNQUFNLENBQUMsQ0FBQztZQUMvQixLQUFLLE1BQU0sSUFBSSxJQUFJLE1BQU0sRUFBRTtnQkFDdkIsTUFBTSxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsQ0FBQzthQUNwQjtZQUNELE1BQU0sQ0FBQyxNQUFNLEdBQUcsQ0FBQyxDQUFDO1lBQ2xCLE1BQU0sQ0FBQyxJQUFJLENBQUMsR0FBRyxNQUFNLENBQUMsQ0FBQztTQUMxQjthQUFNLElBQUksTUFBTSxZQUFZLE1BQU0sSUFBSSxNQUFNLFlBQVksTUFBTSxFQUFFO1lBQzdELEtBQUssTUFBTSxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsSUFBSSxNQUFNLENBQUMsT0FBTyxDQUFTLE1BQU0sQ0FBQyxFQUFFO2dCQUNqRCxJQUFJLE1BQU0sQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxXQUFXLEtBQUssTUFBTSxJQUFJLENBQUMsQ0FBQyxXQUFXLEtBQUssS0FBSyxDQUFDLEVBQUU7b0JBQ3BFLFlBQVksQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUM7aUJBQzlCO3FCQUFNO29CQUNILE1BQU0sQ0FBQyxDQUFDLENBQUMsR0FBRyxDQUFDLENBQUM7aUJBQ2pCO2FBQ0o7U0FDSjtLQUNKO0FBQ0wsQ0FBQztBQUVELFNBQVMsYUFBYSxDQUFDLFFBQVE7SUFDM0IsSUFBSTtRQUNBLE9BQU8sWUFBRSxDQUFDLFFBQVEsQ0FBQyxRQUFRLENBQUMsQ0FBQztLQUNoQztJQUFDLE9BQU8sT0FBTyxFQUFFO1FBQ2QsTUFBTSxJQUFJLEtBQUssQ0FBQyxzQ0FBc0MsUUFBUSxHQUFHLENBQUMsQ0FBQztLQUN0RTtBQUNMLENBQUM7QUFFRCxTQUFTLGdCQUFnQixDQUFDLElBQUk7SUFDMUIsTUFBTSxRQUFRLEdBQUcsY0FBSSxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsQ0FBQztJQUNwQyxJQUFJLENBQUMsYUFBYSxDQUFDLFFBQVEsQ0FBQyxDQUFDLFdBQVcsRUFBRSxFQUFFO1FBQ3hDLE1BQU0sSUFBSSxLQUFLLENBQUMsNEJBQTRCLFFBQVEsR0FBRyxDQUFDLENBQUM7S0FDNUQ7SUFDRCxPQUFPLFFBQVEsQ0FBQztBQUNwQixDQUFDO0FBRUQsU0FBZ0IsY0FBYyxDQUFDLElBQVU7SUFFckMsTUFBTSxPQUFPLEdBQUcsY0FBSSxDQUFDLE9BQU8sQ0FBQyxTQUFTLEVBQUUsSUFBSSxDQUFDLENBQUM7SUFDOUMsTUFBTSxPQUFPLEdBQUcsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsZ0JBQWdCLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQyxPQUFPLENBQUMsR0FBRyxFQUFFLENBQUM7SUFFeEUsTUFBTSxnQkFBZ0IsR0FBRyxDQUFDLFFBQVEsRUFBRSxFQUFFO1FBQ2xDLElBQUk7WUFDQSxPQUFPLFlBQUUsQ0FBQyxZQUFZLENBQUMsY0FBSSxDQUFDLE9BQU8sQ0FBQyxPQUFPLEVBQUUsUUFBUSxDQUFDLEVBQUUsT0FBTyxDQUFDLENBQUM7U0FDcEU7UUFBQyxPQUFPLE9BQU8sRUFBRTtZQUNkLE9BQU8sWUFBRSxDQUFDLFlBQVksQ0FBQyxjQUFJLENBQUMsT0FBTyxDQUFDLE9BQU8sRUFBRSxRQUFRLENBQUMsRUFBRSxPQUFPLENBQUMsQ0FBQztTQUNwRTtJQUNMLENBQUMsQ0FBQztJQUVGLE9BQU8sTUFBTSxDQUFDLE1BQU0sQ0FBQztRQUNqQixPQUFPO1FBQ1AsR0FBRyxFQUFFO1lBQ0QsS0FBSyxFQUFFLE1BQU07U0FDaEI7UUFDRCxLQUFLLEVBQUUsTUFBTTtRQUNiLE1BQU0sRUFBRTtZQUNKLFFBQVEsRUFBRSxPQUFPO1lBQ2pCLElBQUksRUFBRSxXQUFXO1lBQ2pCLElBQUksRUFBRSxJQUFJO1lBQ1YsT0FBTyxFQUFFO2dCQUNMLElBQUksR0FBRztvQkFDSCxPQUFPLGdCQUFnQixDQUFDLG9CQUFvQixDQUFDLENBQUM7Z0JBQ2xELENBQUM7Z0JBQ0QsSUFBSSxJQUFJO29CQUNKLE9BQU8sZ0JBQWdCLENBQUMsb0JBQW9CLENBQUMsQ0FBQztnQkFDbEQsQ0FBQztnQkFDRCxVQUFVLEVBQUUsSUFBSTthQUNuQjtTQUNKO1FBQ0QsU0FBUyxFQUFFLGNBQUksQ0FBQyxPQUFPLENBQUMsT0FBTyxFQUFFLFdBQVcsQ0FBQztRQUM3QyxPQUFPLEVBQUU7WUFDTCxHQUFHLEVBQUUsT0FBTztZQUNaLE1BQU0sRUFBRSxLQUFLO1lBQ2IsT0FBTyxFQUFFO2dCQUNMLGlCQUFpQjtnQkFDakIsZ0JBQWdCO2FBQ25CO1NBQ0o7UUFDRCxNQUFNLEVBQUU7WUFDSixtQkFBbUIsRUFBRSxJQUFJO1lBQ3pCLGdCQUFnQixFQUFFLElBQUk7U0FDekI7UUFDRCxVQUFVLEVBQUUsRUFBRTtRQUNkLEtBQUssRUFBRTtZQUNILE1BQU0sRUFBRSxFQUFDLE1BQU0sRUFBRSx1QkFBdUIsRUFBQztTQUM1QztRQUNELElBQUksRUFBRTtZQUNGLE1BQU0sRUFBRSxHQUFHO1lBQ1gsT0FBTyxFQUFFLHFDQUFxQztZQUM5QyxjQUFjLEVBQUUsd0NBQXdDO1lBQ3hELFdBQVcsRUFBRSxJQUFJO1NBQ3BCO1FBQ0QsS0FBSyxFQUFFLElBQUk7UUFDWCxPQUFPLEVBQUUsSUFBSTtRQUNiLElBQUksRUFBRTtZQUNGLElBQUksRUFBRSxLQUFLO1NBQ2Q7UUFDRCxLQUFLLEVBQUU7WUFDSCxHQUFHLEVBQUUsT0FBTztTQUNmO1FBQ0QsS0FBSyxFQUFFO1lBQ0gsT0FBTyxFQUFFLElBQUk7WUFDYixNQUFNLEVBQUU7Z0JBQ0osSUFBSSxFQUFFLGlCQUFpQjtnQkFDdkIsaUJBQWlCLEVBQUUsSUFBSTthQUMxQjtZQUNELFVBQVUsRUFBRSxRQUFRO1lBQ3BCLFVBQVUsRUFBRSxJQUFJO1lBQ2hCLE9BQU8sRUFBRTtnQkFDTCxDQUFDLGtDQUFrQyxDQUFDO2dCQUNwQyxDQUFDLGlDQUFpQyxFQUFFO3dCQUNoQyxRQUFRLEVBQUUsS0FBSzt3QkFDZixTQUFTLEVBQUUsSUFBSTt3QkFDZixhQUFhLEVBQUUsS0FBSzt3QkFDcEIsY0FBYyxFQUFFLElBQUk7d0JBQ3BCLGlCQUFpQixFQUFFLEtBQUs7d0JBQ3hCLFNBQVMsRUFBRSxRQUFRO3FCQUN0QixDQUFDO2FBQ0w7U0FDSjtRQUNELElBQUksRUFBRTtZQUNGLFVBQVUsRUFBRSxDQUFDLE9BQU8sRUFBRSxNQUFNLEVBQUUsT0FBTyxDQUFDO1lBQ3RDLFdBQVcsRUFBRSxVQUFVO1lBQ3ZCLEdBQUcsRUFBRSxJQUFJO1NBQ1o7S0FDSixFQUFFLE9BQU8sQ0FBQyw0Q0FBNEMsQ0FBQyxDQUFDLENBQUM7QUFDOUQsQ0FBQztBQTFGRCx3Q0EwRkM7QUFTRCxTQUFnQixTQUFTLENBQUMsT0FBYSxFQUFFLEVBQUUsUUFBUztJQUVoRCxJQUFJLE9BQU8sR0FBbUIsY0FBYyxDQUFDLElBQUksQ0FBQyxDQUFDO0lBRW5ELElBQUksSUFBSSxDQUFDLE1BQU0sRUFBRTtRQUNiLFlBQVksQ0FBQyxPQUFPLEVBQUUsVUFBVSxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDO0tBQ2xEO1NBQU07UUFDSCxNQUFNLFVBQVUsR0FBRyxhQUFhLENBQUMsY0FBSSxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsT0FBTyxFQUFFLGdCQUFnQixDQUFDLENBQUMsQ0FBQztRQUMvRSxNQUFNLFdBQVcsR0FBRyxhQUFhLENBQUMsZ0JBQWdCLENBQUMsQ0FBQztRQUNwRCxJQUFJLFVBQVUsRUFBRTtZQUNaLElBQUksV0FBVyxLQUFLLFVBQVUsRUFBRTtnQkFDNUIsWUFBWSxDQUFDLE9BQU8sRUFBRSxVQUFVLENBQUMsVUFBVSxDQUFDLENBQUMsQ0FBQzthQUNqRDtTQUNKO2FBQU07WUFDSCxnQkFBRyxDQUFDLEtBQUssQ0FBQyx1QkFBdUIsT0FBTyxDQUFDLE9BQU8sR0FBRyxDQUFDLENBQUM7U0FDeEQ7UUFDRCxJQUFJLFdBQVcsRUFBRTtZQUNiLFlBQVksQ0FBQyxPQUFPLEVBQUUsVUFBVSxDQUFDLFdBQVcsQ0FBQyxDQUFDLENBQUM7U0FDbEQ7YUFBTTtZQUNILGdCQUFHLENBQUMsS0FBSyxDQUFDLHVCQUF1QixPQUFPLENBQUMsR0FBRyxFQUFFLEdBQUcsQ0FBQyxDQUFDO1NBQ3REO0tBQ0o7SUFFRCxJQUFJLFFBQVEsRUFBRTtRQUNWLFlBQVksQ0FBQyxPQUFPLEVBQUUsUUFBUSxDQUFDLENBQUM7S0FDbkM7SUFFRCxNQUFNLE9BQU8sR0FBRyxPQUFPLENBQUMsT0FBTyxJQUFJLEVBQUUsQ0FBQztJQUV0QyxJQUFJLElBQUksQ0FBQyxNQUFNLEVBQUU7UUFDYixNQUFNLEtBQUssR0FBRyxLQUFLLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLENBQUM7UUFDdkUsS0FBSyxNQUFNLElBQUksSUFBSSxLQUFLO1lBQUUsSUFBSTtnQkFDMUIsT0FBTyxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsT0FBTyxDQUFDLElBQUksRUFBRSxFQUFDLEtBQUssRUFBRSxDQUFDLE9BQU8sQ0FBQyxPQUFPLENBQUMsRUFBQyxDQUFDLENBQUMsQ0FBQzthQUNuRTtZQUFDLE9BQU8sS0FBSyxFQUFFO2dCQUNaLElBQUk7b0JBQ0EsT0FBTyxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsT0FBTyxDQUFDLElBQUksRUFBRSxFQUFDLEtBQUssRUFBRSxDQUFDLFNBQVMsQ0FBQyxFQUFDLENBQUMsQ0FBQyxDQUFDO2lCQUM3RDtnQkFBQyxPQUFPLEtBQUssRUFBRTtvQkFDWixnQkFBRyxDQUFDLEtBQUssQ0FBQyxVQUFVLEdBQUcsSUFBSSxHQUFHLHNCQUFzQixFQUFFLEtBQUssQ0FBQyxDQUFDO29CQUM3RCxPQUFPLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDO2lCQUNuQjthQUNKO0tBQ0o7SUFFRCxLQUFLLElBQUksTUFBTSxJQUFJLE9BQU87UUFBRSxJQUFJO1lBQzVCLElBQUksT0FBTyxNQUFNLEtBQUssUUFBUSxFQUFFO2dCQUM1QixNQUFNLEdBQUcsT0FBTyxDQUFDLE1BQU0sQ0FBbUIsQ0FBQzthQUM5QztZQUNELElBQUksTUFBTSxDQUFDLE9BQU8sRUFBRTtnQkFDaEIsWUFBWSxDQUFDLE1BQU0sQ0FBQyxPQUFPLEVBQUUsTUFBTSxDQUFDLENBQUM7Z0JBQ3JDLE1BQU0sR0FBRyxNQUFNLENBQUMsT0FBTyxDQUFDO2dCQUN4QixPQUFPLE1BQU0sQ0FBQyxPQUFPLENBQUM7YUFDekI7WUFDRCxZQUFZLENBQUMsT0FBTyxFQUFFLE1BQU0sQ0FBQyxDQUFDO1NBQ2pDO1FBQUMsT0FBTyxLQUFLLEVBQUU7WUFDWixnQkFBRyxDQUFDLEtBQUssQ0FBQyxVQUFVLEdBQUcsTUFBTSxHQUFHLG1CQUFtQixFQUFFLEtBQUssQ0FBQyxDQUFDO1lBQzVELE9BQU8sQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUM7U0FDbkI7SUFFRCxJQUFJLE9BQU8sQ0FBQyxHQUFHLEVBQUU7UUFDYixNQUFNLENBQUMsTUFBTSxDQUFDLGdCQUFHLEVBQUUsT0FBTyxDQUFDLEdBQUcsQ0FBQyxDQUFDO0tBQ25DO0lBRUQsSUFBSSxJQUFJLENBQUMsS0FBSyxFQUFFO1FBQ1osZ0JBQUcsQ0FBQyxLQUFLLEdBQUcsT0FBTyxDQUFDO0tBQ3ZCO0lBRUQsZ0JBQUcsQ0FBQyxLQUFLLENBQUMsYUFBYSxFQUFFLE9BQU8sQ0FBQyxDQUFDO0lBRWxDLE9BQU8sT0FBTyxDQUFDO0FBQ25CLENBQUM7QUFyRUQsOEJBcUVDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtUcmFuc2Zvcm1PcHRpb25zfSBmcm9tIFwiQGJhYmVsL2NvcmVcIjtcclxuaW1wb3J0IHtGU1dhdGNoZXIsIFdhdGNoT3B0aW9uc30gZnJvbSBcImNob2tpZGFyXCI7XHJcbmltcG9ydCB7Q29yc09wdGlvbnN9IGZyb20gXCJjb3JzXCI7XHJcbmltcG9ydCB7V2ViTW9kdWxlc09wdGlvbnN9IGZyb20gXCJAbW9kZXJuby93ZWItbW9kdWxlc1wiO1xyXG5pbXBvcnQge09wdGlvbnN9IGZyb20gXCJldGFnXCI7XHJcbmltcG9ydCBSb3V0ZXIsIHtIVFRQVmVyc2lvbn0gZnJvbSBcImZpbmQtbXktd2F5XCI7XHJcbmltcG9ydCBmcyBmcm9tIFwiZnNcIjtcclxuaW1wb3J0IFNlcnZlciBmcm9tIFwiaHR0cC1wcm94eVwiO1xyXG5pbXBvcnQge1N5bmNPcHRpb25zfSBmcm9tIFwibm9kZS1zYXNzXCI7XHJcbmltcG9ydCBwYXRoIGZyb20gXCJwYXRoXCI7XHJcbmltcG9ydCBsb2cgZnJvbSBcIkBtb2Rlcm5vL2xvZ2dlclwiO1xyXG5pbXBvcnQge1NlcnZlck9wdGlvbnN9IGZyb20gXCIuL3NlcnZlclwiO1xyXG5pbXBvcnQge01lc3NhZ2luZ09wdGlvbnN9IGZyb20gXCIuL21lc3NhZ2luZ1wiO1xyXG5cclxuZXhwb3J0IHR5cGUgRmluZE15V2F5TWlkZGxld2FyZSA9IChcclxuICAgIHJvdXRlcjogUm91dGVyLkluc3RhbmNlPEhUVFBWZXJzaW9uLlYxIHwgSFRUUFZlcnNpb24uVjI+LFxyXG4gICAgb3B0aW9uczogTW9kZXJub09wdGlvbnMsXHJcbiAgICB3YXRjaGVyOiBGU1dhdGNoZXJcclxuKSA9PiB2b2lkO1xyXG5cclxuZXhwb3J0IHR5cGUgTW9kZXJub09wdGlvbnMgPSBXZWJNb2R1bGVzT3B0aW9ucyAmIHtcclxuICAgIGV4dGVuZHM/OiBNb2Rlcm5vT3B0aW9uc1xyXG4gICAgcm9vdERpcjogc3RyaW5nXHJcbiAgICBsb2c/OiB7XHJcbiAgICAgICAgbGV2ZWw6IFwidHJhY2VcIiB8IFwiZGVidWdcIiB8IFwiaW5mb1wiIHwgXCJ3YXJuXCIgfCBcImVycm9yXCIgfCBcIm5vdGhpbmdcIlxyXG4gICAgICAgIGRldGFpbHM/OiBib29sZWFuXHJcbiAgICAgICAgY29tcGFjdD86IGJvb2xlYW5cclxuICAgIH1cclxuICAgIGh0dHAyPzogXCJwdXNoXCIgfCBcInByZWxvYWRcIiB8IGZhbHNlXHJcbiAgICBzZXJ2ZXI/OiBTZXJ2ZXJPcHRpb25zXHJcbiAgICByZXNvdXJjZXM6IHN0cmluZ1xyXG4gICAgd2F0Y2hlcj86IFdhdGNoT3B0aW9uc1xyXG4gICAgcm91dGVyOiBSb3V0ZXIuQ29uZmlnPEhUVFBWZXJzaW9uLlYxIHwgSFRUUFZlcnNpb24uVjI+XHJcbiAgICBtaWRkbGV3YXJlOiBGaW5kTXlXYXlNaWRkbGV3YXJlW11cclxuICAgIHByb3h5OiB7IFtwYXRoOiBzdHJpbmddOiBTZXJ2ZXIuU2VydmVyT3B0aW9ucyB9XHJcbiAgICBjb3JzOiBDb3JzT3B0aW9uc1xyXG4gICAgZXRhZzogT3B0aW9uc1xyXG4gICAgY2FjaGU/OiBib29sZWFuXHJcbiAgICBlbmNvZGluZzogXCJnemlwXCIgfCBcImJyb3RsaVwiIHwgXCJiclwiIHwgXCJkZWZsYXRlXCIgfCBcImRlZmxhdGUtcmF3XCIgfCB1bmRlZmluZWRcclxuICAgIHRyYW5zZm9ybToge1xyXG4gICAgICAgIGluY2x1ZGU6IHN0cmluZyB8IHN0cmluZ1tdXHJcbiAgICAgICAgZXhjbHVkZTogc3RyaW5nIHwgc3RyaW5nW11cclxuICAgICAgICBwcmVQcm9jZXNzPyhmaWxlbmFtZTogc3RyaW5nLCBjb2RlOiBzdHJpbmcpOiBzdHJpbmdcclxuICAgIH1cclxuICAgIG1vdW50OiB7IFtwYXRoOiBzdHJpbmddOiBzdHJpbmcgfVxyXG4gICAgYmFiZWw6IFRyYW5zZm9ybU9wdGlvbnNcclxuICAgIHNhc3M6IFN5bmNPcHRpb25zICYgeyBITVI6IGJvb2xlYW4gfVxyXG4gICAgbWVzc2FnaW5nPzogTWVzc2FnaW5nT3B0aW9uc1xyXG4gICAgcGx1Z2luczogKE1vZGVybm9PcHRpb25zfHN0cmluZylbXVxyXG59XHJcblxyXG5mdW5jdGlvbiBsb2FkQ29uZmlnKHBhdGhuYW1lOiBzdHJpbmcpOiBzdHJpbmcge1xyXG4gICAgdHJ5IHtcclxuICAgICAgICBsZXQgY29uZmlnID0gcmVxdWlyZShwYXRoLnJlc29sdmUocGF0aG5hbWUpKTtcclxuICAgICAgICBpZiAoY29uZmlnLmV4dGVuZHMpIHtcclxuICAgICAgICAgICAgY29uc3QgYmFzZSA9IGNvbmZpZy5leHRlbmRzO1xyXG4gICAgICAgICAgICBkZWxldGUgY29uZmlnLmV4dGVuZHM7XHJcbiAgICAgICAgICAgIGNvbmZpZyA9IGFzc2lnbkNvbmZpZyhiYXNlLCBjb25maWcpO1xyXG4gICAgICAgIH1cclxuICAgICAgICByZXR1cm4gY29uZmlnO1xyXG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcclxuICAgICAgICBsb2cuZXJyb3IoYFVuYWJsZSB0byBsb2FkIGNvbmZpZyAnJHtwYXRobmFtZX0nIGZyb20gJyR7cHJvY2Vzcy5jd2QoKX0nXFxuYCwgZXJyb3IpO1xyXG4gICAgICAgIHByb2Nlc3MuZXhpdCgxKTtcclxuICAgIH1cclxufVxyXG5cclxuZnVuY3Rpb24gcmVzb2x2ZUNvbmZpZyhwYXRobmFtZTogc3RyaW5nKTogc3RyaW5nIHwgbnVsbCB7XHJcbiAgICB0cnkge1xyXG4gICAgICAgIHJldHVybiByZXF1aXJlLnJlc29sdmUocGF0aC5yZXNvbHZlKHBhdGhuYW1lKSk7XHJcbiAgICB9IGNhdGNoIChpZ25vcmVkKSB7XHJcbiAgICAgICAgcmV0dXJuIG51bGw7XHJcbiAgICB9XHJcbn1cclxuXHJcbmZ1bmN0aW9uIGFzc2lnbkNvbmZpZzxWPih0YXJnZXQ6IFYsIHNvdXJjZTogYW55KSB7XHJcbiAgICBpZiAoc291cmNlICE9PSB1bmRlZmluZWQgJiYgc291cmNlICE9PSBudWxsKSB7XHJcbiAgICAgICAgaWYgKHRhcmdldCBpbnN0YW5jZW9mIEFycmF5ICYmIHNvdXJjZSBpbnN0YW5jZW9mIEFycmF5KSB7XHJcbiAgICAgICAgICAgIGNvbnN0IG1lcmdlZCA9IG5ldyBTZXQodGFyZ2V0KTtcclxuICAgICAgICAgICAgZm9yIChjb25zdCBpdGVtIG9mIHNvdXJjZSkge1xyXG4gICAgICAgICAgICAgICAgbWVyZ2VkLmFkZChpdGVtKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB0YXJnZXQubGVuZ3RoID0gMDtcclxuICAgICAgICAgICAgdGFyZ2V0LnB1c2goLi4ubWVyZ2VkKTtcclxuICAgICAgICB9IGVsc2UgaWYgKHRhcmdldCBpbnN0YW5jZW9mIE9iamVjdCAmJiBzb3VyY2UgaW5zdGFuY2VvZiBPYmplY3QpIHtcclxuICAgICAgICAgICAgZm9yIChjb25zdCBbaywgdl0gb2YgT2JqZWN0LmVudHJpZXM8b2JqZWN0Pihzb3VyY2UpKSB7XHJcbiAgICAgICAgICAgICAgICBpZiAodGFyZ2V0W2tdICYmICh2LmNvbnN0cnVjdG9yID09PSBPYmplY3QgfHwgdi5jb25zdHJ1Y3RvciA9PT0gQXJyYXkpKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgYXNzaWduQ29uZmlnKHRhcmdldFtrXSwgdik7XHJcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgIHRhcmdldFtrXSA9IHY7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICB9XHJcbn1cclxuXHJcbmZ1bmN0aW9uIHN0YXREaXJlY3RvcnkocGF0aG5hbWUpIHtcclxuICAgIHRyeSB7XHJcbiAgICAgICAgcmV0dXJuIGZzLnN0YXRTeW5jKHBhdGhuYW1lKTtcclxuICAgIH0gY2F0Y2ggKGlnbm9yZWQpIHtcclxuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYEVOT0VOVDogbm8gc3VjaCBmaWxlIG9yIGRpcmVjdG9yeSAnJHtwYXRobmFtZX0nYCk7XHJcbiAgICB9XHJcbn1cclxuXHJcbmZ1bmN0aW9uIHJlc29sdmVEaXJlY3RvcnkobmFtZSkge1xyXG4gICAgY29uc3QgcGF0aG5hbWUgPSBwYXRoLnJlc29sdmUobmFtZSk7XHJcbiAgICBpZiAoIXN0YXREaXJlY3RvcnkocGF0aG5hbWUpLmlzRGlyZWN0b3J5KCkpIHtcclxuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYEVOT0RJUjogbm90IGEgZGlyZWN0b3J5ICcke3BhdGhuYW1lfSdgKTtcclxuICAgIH1cclxuICAgIHJldHVybiBwYXRobmFtZTtcclxufVxyXG5cclxuZXhwb3J0IGZ1bmN0aW9uIGRlZmF1bHRPcHRpb25zKGFyZ3M6IEFyZ3MpOiBNb2Rlcm5vT3B0aW9ucyB7XHJcblxyXG4gICAgY29uc3QgYmFzZURpciA9IHBhdGgucmVzb2x2ZShfX2Rpcm5hbWUsIFwiLi5cIik7XHJcbiAgICBjb25zdCByb290RGlyID0gYXJncy5yb290ID8gcmVzb2x2ZURpcmVjdG9yeShhcmdzLnJvb3QpIDogcHJvY2Vzcy5jd2QoKTtcclxuXHJcbiAgICBjb25zdCByZWFkVGV4dEZpbGVTeW5jID0gKGZpbGVuYW1lKSA9PiB7XHJcbiAgICAgICAgdHJ5IHtcclxuICAgICAgICAgICAgcmV0dXJuIGZzLnJlYWRGaWxlU3luYyhwYXRoLnJlc29sdmUocm9vdERpciwgZmlsZW5hbWUpLCBcInV0Zi04XCIpO1xyXG4gICAgICAgIH0gY2F0Y2ggKGlnbm9yZWQpIHtcclxuICAgICAgICAgICAgcmV0dXJuIGZzLnJlYWRGaWxlU3luYyhwYXRoLnJlc29sdmUoYmFzZURpciwgZmlsZW5hbWUpLCBcInV0Zi04XCIpO1xyXG4gICAgICAgIH1cclxuICAgIH07XHJcblxyXG4gICAgcmV0dXJuIE9iamVjdC5hc3NpZ24oe1xyXG4gICAgICAgIHJvb3REaXIsXHJcbiAgICAgICAgbG9nOiB7XHJcbiAgICAgICAgICAgIGxldmVsOiBcImluZm9cIlxyXG4gICAgICAgIH0sXHJcbiAgICAgICAgaHR0cDI6IFwicHVzaFwiLFxyXG4gICAgICAgIHNlcnZlcjoge1xyXG4gICAgICAgICAgICBwcm90b2NvbDogXCJodHRwc1wiLFxyXG4gICAgICAgICAgICBob3N0OiBcImxvY2FsaG9zdFwiLFxyXG4gICAgICAgICAgICBwb3J0OiAzMDAwLFxyXG4gICAgICAgICAgICBvcHRpb25zOiB7XHJcbiAgICAgICAgICAgICAgICBnZXQga2V5KCkge1xyXG4gICAgICAgICAgICAgICAgICAgIHJldHVybiByZWFkVGV4dEZpbGVTeW5jKFwiY2VydC9sb2NhbGhvc3Qua2V5XCIpO1xyXG4gICAgICAgICAgICAgICAgfSxcclxuICAgICAgICAgICAgICAgIGdldCBjZXJ0KCkge1xyXG4gICAgICAgICAgICAgICAgICAgIHJldHVybiByZWFkVGV4dEZpbGVTeW5jKFwiY2VydC9sb2NhbGhvc3QuY3J0XCIpO1xyXG4gICAgICAgICAgICAgICAgfSxcclxuICAgICAgICAgICAgICAgIGFsbG93SFRUUDE6IHRydWVcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH0sXHJcbiAgICAgICAgcmVzb3VyY2VzOiBwYXRoLnJlc29sdmUoYmFzZURpciwgXCJyZXNvdXJjZXNcIiksXHJcbiAgICAgICAgd2F0Y2hlcjoge1xyXG4gICAgICAgICAgICBjd2Q6IHJvb3REaXIsXHJcbiAgICAgICAgICAgIGF0b21pYzogZmFsc2UsXHJcbiAgICAgICAgICAgIGlnbm9yZWQ6IFtcclxuICAgICAgICAgICAgICAgIFwibm9kZV9tb2R1bGVzLyoqXCIsXHJcbiAgICAgICAgICAgICAgICBcIndlYl9tb2R1bGVzLyoqXCJcclxuICAgICAgICAgICAgXVxyXG4gICAgICAgIH0sXHJcbiAgICAgICAgcm91dGVyOiB7XHJcbiAgICAgICAgICAgIGlnbm9yZVRyYWlsaW5nU2xhc2g6IHRydWUsXHJcbiAgICAgICAgICAgIGFsbG93VW5zYWZlUmVnZXg6IHRydWVcclxuICAgICAgICB9LFxyXG4gICAgICAgIG1pZGRsZXdhcmU6IFtdLFxyXG4gICAgICAgIHByb3h5OiB7XHJcbiAgICAgICAgICAgIFwiL2FwaVwiOiB7dGFyZ2V0OiBcImh0dHA6Ly9sb2NhbGhvc3Q6OTAwMFwifVxyXG4gICAgICAgIH0sXHJcbiAgICAgICAgY29yczoge1xyXG4gICAgICAgICAgICBvcmlnaW46IFwiKlwiLFxyXG4gICAgICAgICAgICBtZXRob2RzOiBcIkdFVCwgSEVBRCwgUFVULCBQT1NULCBERUxFVEUsIFBBVENIXCIsXHJcbiAgICAgICAgICAgIGFsbG93ZWRIZWFkZXJzOiBcIlgtUmVxdWVzdGVkLVdpdGgsIEFjY2VwdCwgQ29udGVudC1UeXBlXCIsXHJcbiAgICAgICAgICAgIGNyZWRlbnRpYWxzOiB0cnVlXHJcbiAgICAgICAgfSxcclxuICAgICAgICBjYWNoZTogdHJ1ZSxcclxuICAgICAgICBkZWZsYXRlOiB0cnVlLFxyXG4gICAgICAgIGV0YWc6IHtcclxuICAgICAgICAgICAgd2VhazogZmFsc2VcclxuICAgICAgICB9LFxyXG4gICAgICAgIG1vdW50OiB7XHJcbiAgICAgICAgICAgIFwiL1wiOiByb290RGlyXHJcbiAgICAgICAgfSxcclxuICAgICAgICBiYWJlbDoge1xyXG4gICAgICAgICAgICBiYWJlbHJjOiB0cnVlLFxyXG4gICAgICAgICAgICBjYWxsZXI6IHtcclxuICAgICAgICAgICAgICAgIG5hbWU6IFwiQG1vZGVybm8vc2VydmVyXCIsXHJcbiAgICAgICAgICAgICAgICBzdXBwb3J0c1N0YXRpY0VTTTogdHJ1ZVxyXG4gICAgICAgICAgICB9LFxyXG4gICAgICAgICAgICBzb3VyY2VUeXBlOiBcIm1vZHVsZVwiLFxyXG4gICAgICAgICAgICBzb3VyY2VNYXBzOiB0cnVlLFxyXG4gICAgICAgICAgICBwbHVnaW5zOiBbXHJcbiAgICAgICAgICAgICAgICBbXCJAYmFiZWwvcGx1Z2luLXN5bnRheC1pbXBvcnQtbWV0YVwiXSxcclxuICAgICAgICAgICAgICAgIFtcIkBiYWJlbC9wbHVnaW4tdHJhbnNmb3JtLXJ1bnRpbWVcIiwge1xyXG4gICAgICAgICAgICAgICAgICAgIFwiY29yZWpzXCI6IGZhbHNlLFxyXG4gICAgICAgICAgICAgICAgICAgIFwiaGVscGVyc1wiOiB0cnVlLFxyXG4gICAgICAgICAgICAgICAgICAgIFwicmVnZW5lcmF0b3JcIjogZmFsc2UsXHJcbiAgICAgICAgICAgICAgICAgICAgXCJ1c2VFU01vZHVsZXNcIjogdHJ1ZSxcclxuICAgICAgICAgICAgICAgICAgICBcImFic29sdXRlUnVudGltZVwiOiBmYWxzZSxcclxuICAgICAgICAgICAgICAgICAgICBcInZlcnNpb25cIjogXCI3LjEwLjVcIlxyXG4gICAgICAgICAgICAgICAgfV1cclxuICAgICAgICAgICAgXVxyXG4gICAgICAgIH0sXHJcbiAgICAgICAgc2Fzczoge1xyXG4gICAgICAgICAgICBleHRlbnNpb25zOiBbXCIuc2Nzc1wiLCBcIi5jc3NcIiwgXCIuc2Fzc1wiXSxcclxuICAgICAgICAgICAgb3V0cHV0U3R5bGU6IFwiZXhwYW5kZWRcIixcclxuICAgICAgICAgICAgSE1SOiB0cnVlXHJcbiAgICAgICAgfVxyXG4gICAgfSwgcmVxdWlyZShcIkBtb2Rlcm5vL3dlYi1tb2R1bGVzL3dlYi1tb2R1bGVzLmNvbmZpZy5qc1wiKSk7XHJcbn1cclxuXHJcbmV4cG9ydCB0eXBlIEFyZ3MgPSB7XHJcbiAgICBjb25maWc/OiBzdHJpbmdcclxuICAgIHJvb3Q/OiBzdHJpbmdcclxuICAgIHBsdWdpbj86IHN0cmluZyB8IHN0cmluZ1tdXHJcbiAgICBkZWJ1Zz86IGJvb2xlYW5cclxufVxyXG5cclxuZXhwb3J0IGZ1bmN0aW9uIGNvbmZpZ3VyZShhcmdzOiBBcmdzID0ge30sIG92ZXJyaWRlPyk6IFJlYWRvbmx5PE1vZGVybm9PcHRpb25zPiB7XHJcblxyXG4gICAgbGV0IG9wdGlvbnM6IE1vZGVybm9PcHRpb25zID0gZGVmYXVsdE9wdGlvbnMoYXJncyk7XHJcblxyXG4gICAgaWYgKGFyZ3MuY29uZmlnKSB7XHJcbiAgICAgICAgYXNzaWduQ29uZmlnKG9wdGlvbnMsIGxvYWRDb25maWcoYXJncy5jb25maWcpKTtcclxuICAgIH0gZWxzZSB7XHJcbiAgICAgICAgY29uc3Qgcm9vdENvbmZpZyA9IHJlc29sdmVDb25maWcocGF0aC5qb2luKG9wdGlvbnMucm9vdERpciwgXCJtb2Rlcm5vLmNvbmZpZ1wiKSk7XHJcbiAgICAgICAgY29uc3QgbG9jYWxDb25maWcgPSByZXNvbHZlQ29uZmlnKFwibW9kZXJuby5jb25maWdcIik7XHJcbiAgICAgICAgaWYgKHJvb3RDb25maWcpIHtcclxuICAgICAgICAgICAgaWYgKGxvY2FsQ29uZmlnICE9PSByb290Q29uZmlnKSB7XHJcbiAgICAgICAgICAgICAgICBhc3NpZ25Db25maWcob3B0aW9ucywgbG9hZENvbmZpZyhyb290Q29uZmlnKSk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICBsb2cuZGVidWcoYG5vIGNvbmZpZyBmb3VuZCBpbiAnJHtvcHRpb25zLnJvb3REaXJ9J2ApO1xyXG4gICAgICAgIH1cclxuICAgICAgICBpZiAobG9jYWxDb25maWcpIHtcclxuICAgICAgICAgICAgYXNzaWduQ29uZmlnKG9wdGlvbnMsIGxvYWRDb25maWcobG9jYWxDb25maWcpKTtcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICBsb2cuZGVidWcoYG5vIGNvbmZpZyBmb3VuZCBpbiAnJHtwcm9jZXNzLmN3ZCgpfSdgKTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgaWYgKG92ZXJyaWRlKSB7XHJcbiAgICAgICAgYXNzaWduQ29uZmlnKG9wdGlvbnMsIG92ZXJyaWRlKTtcclxuICAgIH1cclxuXHJcbiAgICBjb25zdCBwbHVnaW5zID0gb3B0aW9ucy5wbHVnaW5zIHx8IFtdO1xyXG5cclxuICAgIGlmIChhcmdzLnBsdWdpbikge1xyXG4gICAgICAgIGNvbnN0IG5hbWVzID0gQXJyYXkuaXNBcnJheShhcmdzLnBsdWdpbikgPyBhcmdzLnBsdWdpbiA6IFthcmdzLnBsdWdpbl07XHJcbiAgICAgICAgZm9yIChjb25zdCBuYW1lIG9mIG5hbWVzKSB0cnkge1xyXG4gICAgICAgICAgICBwbHVnaW5zLnB1c2gocmVxdWlyZS5yZXNvbHZlKG5hbWUsIHtwYXRoczogW29wdGlvbnMucm9vdERpcl19KSk7XHJcbiAgICAgICAgfSBjYXRjaCAoZXJyb3IpIHtcclxuICAgICAgICAgICAgdHJ5IHtcclxuICAgICAgICAgICAgICAgIHBsdWdpbnMucHVzaChyZXF1aXJlLnJlc29sdmUobmFtZSwge3BhdGhzOiBbX19kaXJuYW1lXX0pKTtcclxuICAgICAgICAgICAgfSBjYXRjaCAoZXJyb3IpIHtcclxuICAgICAgICAgICAgICAgIGxvZy5lcnJvcihcInBsdWdpbiAnXCIgKyBuYW1lICsgXCInIHJlc29sdXRpb24gZmFpbGVkOlwiLCBlcnJvcik7XHJcbiAgICAgICAgICAgICAgICBwcm9jZXNzLmV4aXQoMSk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgZm9yIChsZXQgcGx1Z2luIG9mIHBsdWdpbnMpIHRyeSB7XHJcbiAgICAgICAgaWYgKHR5cGVvZiBwbHVnaW4gPT09IFwic3RyaW5nXCIpIHtcclxuICAgICAgICAgICAgcGx1Z2luID0gcmVxdWlyZShwbHVnaW4pIGFzIE1vZGVybm9PcHRpb25zO1xyXG4gICAgICAgIH1cclxuICAgICAgICBpZiAocGx1Z2luLmV4dGVuZHMpIHtcclxuICAgICAgICAgICAgYXNzaWduQ29uZmlnKHBsdWdpbi5leHRlbmRzLCBwbHVnaW4pO1xyXG4gICAgICAgICAgICBwbHVnaW4gPSBwbHVnaW4uZXh0ZW5kcztcclxuICAgICAgICAgICAgZGVsZXRlIHBsdWdpbi5leHRlbmRzO1xyXG4gICAgICAgIH1cclxuICAgICAgICBhc3NpZ25Db25maWcob3B0aW9ucywgcGx1Z2luKTtcclxuICAgIH0gY2F0Y2ggKGVycm9yKSB7XHJcbiAgICAgICAgbG9nLmVycm9yKFwicGx1Z2luICdcIiArIHBsdWdpbiArIFwiJyBsb2FkaW5nIGZhaWxlZDpcIiwgZXJyb3IpO1xyXG4gICAgICAgIHByb2Nlc3MuZXhpdCgxKTtcclxuICAgIH1cclxuXHJcbiAgICBpZiAob3B0aW9ucy5sb2cpIHtcclxuICAgICAgICBPYmplY3QuYXNzaWduKGxvZywgb3B0aW9ucy5sb2cpO1xyXG4gICAgfVxyXG5cclxuICAgIGlmIChhcmdzLmRlYnVnKSB7XHJcbiAgICAgICAgbG9nLmxldmVsID0gXCJkZWJ1Z1wiO1xyXG4gICAgfVxyXG5cclxuICAgIGxvZy5kZWJ1ZyhcImNvbmZpZ3VyZWQ6XCIsIG9wdGlvbnMpO1xyXG5cclxuICAgIHJldHVybiBvcHRpb25zO1xyXG59XHJcbiJdfQ==