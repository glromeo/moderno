"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.configure = exports.defaultOptions = void 0;
const fs_1 = __importDefault(require("fs"));
const path_1 = __importDefault(require("path"));
const logger_1 = __importDefault(require("@moderno/logger"));
function loadConfig(pathname) {
    try {
        let config = require(path_1.default.resolve(pathname));
        if (config.extends) {
            const base = config.extends;
            delete config.extends;
            config = assignConfig(base, config);
        }
        return config;
    }
    catch (error) {
        logger_1.default.error(`Unable to load config '${pathname}' from '${process.cwd()}'\n`, error);
        process.exit(1);
    }
}
function resolveConfig(pathname) {
    try {
        return require.resolve(path_1.default.resolve(pathname));
    }
    catch (ignored) {
        return null;
    }
}
function assignConfig(target, source) {
    if (source !== undefined && source !== null) {
        if (target instanceof Array && source instanceof Array) {
            const merged = new Set(target);
            for (const item of source) {
                merged.add(item);
            }
            target.length = 0;
            target.push(...merged);
        }
        else if (target instanceof Object && source instanceof Object) {
            for (const [k, v] of Object.entries(source)) {
                if (target[k] && (v.constructor === Object || v.constructor === Array)) {
                    assignConfig(target[k], v);
                }
                else {
                    target[k] = v;
                }
            }
        }
    }
}
function statDirectory(pathname) {
    try {
        return fs_1.default.statSync(pathname);
    }
    catch (ignored) {
        throw new Error(`ENOENT: no such file or directory '${pathname}'`);
    }
}
function resolveDirectory(name) {
    const pathname = path_1.default.resolve(name);
    if (!statDirectory(pathname).isDirectory()) {
        throw new Error(`ENODIR: not a directory '${pathname}'`);
    }
    return pathname;
}
function defaultOptions(args) {
    const baseDir = path_1.default.resolve(__dirname, "..");
    const rootDir = args.root ? resolveDirectory(args.root) : process.cwd();
    const readTextFileSync = (filename) => {
        try {
            return fs_1.default.readFileSync(path_1.default.resolve(rootDir, filename), "utf-8");
        }
        catch (ignored) {
            return fs_1.default.readFileSync(path_1.default.resolve(baseDir, filename), "utf-8");
        }
    };
    return Object.assign({
        rootDir,
        log: {
            level: "info"
        },
        http2: "push",
        server: {
            protocol: "https",
            host: "localhost",
            port: 3000,
            options: {
                get key() {
                    return readTextFileSync("cert/localhost.key");
                },
                get cert() {
                    return readTextFileSync("cert/localhost.crt");
                },
                allowHTTP1: true
            }
        },
        resources: path_1.default.resolve(baseDir, "resources"),
        watcher: {
            cwd: rootDir,
            atomic: false,
            ignored: [
                "node_modules/**",
                "web_modules/**"
            ]
        },
        router: {
            ignoreTrailingSlash: true,
            allowUnsafeRegex: true
        },
        middleware: [],
        proxy: {
            "/api": { target: "http://localhost:9000" }
        },
        cors: {
            origin: "*",
            methods: "GET, HEAD, PUT, POST, DELETE, PATCH",
            allowedHeaders: "X-Requested-With, Accept, Content-Type",
            credentials: true
        },
        cache: true,
        deflate: true,
        etag: {
            weak: false
        },
        mount: {
            "/": rootDir
        },
        babel: {
            babelrc: true,
            caller: {
                name: "@moderno/server",
                supportsStaticESM: true
            },
            sourceType: "module",
            sourceMaps: true,
            plugins: [
                ["@babel/plugin-syntax-import-meta"],
                ["@babel/plugin-transform-runtime", {
                        "corejs": false,
                        "helpers": true,
                        "regenerator": false,
                        "useESModules": true,
                        "absoluteRuntime": false,
                        "version": "7.10.5"
                    }]
            ]
        },
        sass: {
            extensions: [".scss", ".css", ".sass"],
            outputStyle: "expanded"
        }
    }, require("@moderno/web-modules/web-modules.config.js"));
}
exports.defaultOptions = defaultOptions;
function configure(args = {}, override) {
    let options = defaultOptions(args);
    if (args.config) {
        assignConfig(options, loadConfig(args.config));
    }
    else {
        const rootConfig = resolveConfig(path_1.default.join(options.rootDir, "moderno.config"));
        const localConfig = resolveConfig("moderno.config");
        if (rootConfig) {
            if (localConfig !== rootConfig) {
                assignConfig(options, loadConfig(rootConfig));
            }
        }
        else {
            logger_1.default.debug(`no config found in '${options.rootDir}'`);
        }
        if (localConfig) {
            assignConfig(options, loadConfig(localConfig));
        }
        else {
            logger_1.default.debug(`no config found in '${process.cwd()}'`);
        }
    }
    if (override) {
        assignConfig(options, override);
    }
    const plugins = options.plugins || [];
    if (args.plugin) {
        const names = Array.isArray(args.plugin) ? args.plugin : [args.plugin];
        for (const name of names)
            try {
                plugins.push(require.resolve(name, { paths: [options.rootDir] }));
            }
            catch (error) {
                try {
                    plugins.push(require.resolve(name, { paths: [__dirname] }));
                }
                catch (error) {
                    logger_1.default.error("plugin '" + name + "' resolution failed:", error);
                    process.exit(1);
                }
            }
    }
    for (let plugin of plugins)
        try {
            if (typeof plugin === "string") {
                plugin = require(plugin);
            }
            if (plugin.extends) {
                assignConfig(plugin.extends, plugin);
                plugin = plugin.extends;
                delete plugin.extends;
            }
            assignConfig(options, plugin);
        }
        catch (error) {
            logger_1.default.error("plugin '" + plugin + "' loading failed:", error);
            process.exit(1);
        }
    if (options.log) {
        Object.assign(logger_1.default, options.log);
    }
    if (args.debug) {
        logger_1.default.level = "debug";
    }
    logger_1.default.debug("configured:", options);
    return options;
}
exports.configure = configure;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY29uZmlndXJlLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vc3JjL2NvbmZpZ3VyZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7QUFNQSw0Q0FBb0I7QUFHcEIsZ0RBQXdCO0FBQ3hCLDZEQUFrQztBQXlDbEMsU0FBUyxVQUFVLENBQUMsUUFBZ0I7SUFDaEMsSUFBSTtRQUNBLElBQUksTUFBTSxHQUFHLE9BQU8sQ0FBQyxjQUFJLENBQUMsT0FBTyxDQUFDLFFBQVEsQ0FBQyxDQUFDLENBQUM7UUFDN0MsSUFBSSxNQUFNLENBQUMsT0FBTyxFQUFFO1lBQ2hCLE1BQU0sSUFBSSxHQUFHLE1BQU0sQ0FBQyxPQUFPLENBQUM7WUFDNUIsT0FBTyxNQUFNLENBQUMsT0FBTyxDQUFDO1lBQ3RCLE1BQU0sR0FBRyxZQUFZLENBQUMsSUFBSSxFQUFFLE1BQU0sQ0FBQyxDQUFDO1NBQ3ZDO1FBQ0QsT0FBTyxNQUFNLENBQUM7S0FDakI7SUFBQyxPQUFPLEtBQUssRUFBRTtRQUNaLGdCQUFHLENBQUMsS0FBSyxDQUFDLDBCQUEwQixRQUFRLFdBQVcsT0FBTyxDQUFDLEdBQUcsRUFBRSxLQUFLLEVBQUUsS0FBSyxDQUFDLENBQUM7UUFDbEYsT0FBTyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQztLQUNuQjtBQUNMLENBQUM7QUFFRCxTQUFTLGFBQWEsQ0FBQyxRQUFnQjtJQUNuQyxJQUFJO1FBQ0EsT0FBTyxPQUFPLENBQUMsT0FBTyxDQUFDLGNBQUksQ0FBQyxPQUFPLENBQUMsUUFBUSxDQUFDLENBQUMsQ0FBQztLQUNsRDtJQUFDLE9BQU8sT0FBTyxFQUFFO1FBQ2QsT0FBTyxJQUFJLENBQUM7S0FDZjtBQUNMLENBQUM7QUFFRCxTQUFTLFlBQVksQ0FBSSxNQUFTLEVBQUUsTUFBVztJQUMzQyxJQUFJLE1BQU0sS0FBSyxTQUFTLElBQUksTUFBTSxLQUFLLElBQUksRUFBRTtRQUN6QyxJQUFJLE1BQU0sWUFBWSxLQUFLLElBQUksTUFB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OUM7WUFDRCxJQUFJLE1BQU0sQ0FBQyxPQUFPLEVBQUU7Z0JBQ2hCLFlBQVksQ0FBQyxNQUFNLENBQUMsT0FBTyxFQUFFLE1BQU0sQ0FBQyxDQUFDO2dCQUNyQyxNQUFNLEdBQUcsTUFBTSxDQUFDLE9BQU8sQ0FBQztnQkFDeEIsT0FBTyxNQUFNLENBQUMsT0FBTyxDQUFDO2FBQ3pCO1lBQ0QsWUFBWSxDQUFDLE9BQU8sRUFBRSxNQUFNLENBQUMsQ0FBQztTQUNqQztRQUFDLE9BQU8sS0FBSyxFQUFFO1lBQ1osZ0JBQUcsQ0FBQyxLQUFLLENBQUMsVUFBVSxHQUFHLE1BQU0sR0FBRyxtQkFBbUIsRUFBRSxLQUFLLENBQUMsQ0FBQztZQUM1RCxPQUFPLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDO1NBQ25CO0lBRUQsSUFBSSxPQUFPLENBQUMsR0FBRyxFQUFFO1FBQ2IsTUFBTSxDQUFDLE1BQU0sQ0FBQyxnQkFBRyxFQUFFLE9BQU8sQ0FBQyxHQUFHLENBQUMsQ0FBQztLQUNuQztJQUVELElBQUksSUFBSSxDQUFDLEtBQUssRUFBRTtRQUNaLGdCQUFHLENBQUMsS0FBSyxHQUFHLE9BQU8sQ0FBQztLQUN2QjtJQUVELGdCQUFHLENBQUMsS0FBSyxDQUFDLGFBQWEsRUFBRSxPQUFPLENBQUMsQ0FBQztJQUVsQyxPQUFPLE9BQU8sQ0FBQztBQUNuQixDQUFDO0FBckVELDhCQXFFQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7VHJhbnNmb3JtT3B0aW9uc30gZnJvbSBcIkBiYWJlbC9jb3JlXCI7XG5pbXBvcnQge0ZTV2F0Y2hlciwgV2F0Y2hPcHRpb25zfSBmcm9tIFwiY2hva2lkYXJcIjtcbmltcG9ydCB7Q29yc09wdGlvbnN9IGZyb20gXCJjb3JzXCI7XG5pbXBvcnQge1dlYk1vZHVsZXNPcHRpb25zfSBmcm9tIFwiQG1vZGVybm8vd2ViLW1vZHVsZXNcIjtcbmltcG9ydCB7T3B0aW9uc30gZnJvbSBcImV0YWdcIjtcbmltcG9ydCBSb3V0ZXIsIHtIVFRQVmVyc2lvbn0gZnJvbSBcImZpbmQtbXktd2F5XCI7XG5pbXBvcnQgZnMgZnJvbSBcImZzXCI7XG5pbXBvcnQgU2VydmVyIGZyb20gXCJodHRwLXByb3h5XCI7XG5pbXBvcnQge1N5bmNPcHRpb25zfSBmcm9tIFwibm9kZS1zYXNzXCI7XG5pbXBvcnQgcGF0aCBmcm9tIFwicGF0aFwiO1xuaW1wb3J0IGxvZyBmcm9tIFwiQG1vZGVybm8vbG9nZ2VyXCI7XG5pbXBvcnQge1NlcnZlck9wdGlvbnN9IGZyb20gXCIuL3NlcnZlclwiO1xuaW1wb3J0IHtNZXNzYWdpbmdPcHRpb25zfSBmcm9tIFwiLi9tZXNzYWdpbmdcIjtcblxuZXhwb3J0IHR5cGUgRmluZE15V2F5TWlkZGxld2FyZSA9IChcbiAgICByb3V0ZXI6IFJvdXRlci5JbnN0YW5jZTxIVFRQVmVyc2lvbi5WMSB8IEhUVFBWZXJzaW9uLlYyPixcbiAgICBvcHRpb25zOiBNb2Rlcm5vT3B0aW9ucyxcbiAgICB3YXRjaGVyOiBGU1dhdGNoZXJcbikgPT4gdm9pZDtcblxuZXhwb3J0IHR5cGUgTW9kZXJub09wdGlvbnMgPSBXZWJNb2R1bGVzT3B0aW9ucyAmIHtcbiAgICBleHRlbmRzPzogTW9kZXJub09wdGlvbnNcbiAgICByb290RGlyOiBzdHJpbmdcbiAgICBsb2c/OiB7XG4gICAgICAgIGxldmVsOiBcInRyYWNlXCIgfCBcImRlYnVnXCIgfCBcImluZm9cIiB8IFwid2FyblwiIHwgXCJlcnJvclwiIHwgXCJub3RoaW5nXCJcbiAgICAgICAgZGV0YWlscz86IGJvb2xlYW5cbiAgICAgICAgY29tcGFjdD86IGJvb2xlYW5cbiAgICB9XG4gICAgaHR0cDI/OiBcInB1c2hcIiB8IFwicHJlbG9hZFwiIHwgZmFsc2VcbiAgICBzZXJ2ZXI/OiBTZXJ2ZXJPcHRpb25zXG4gICAgcmVzb3VyY2VzOiBzdHJpbmdcbiAgICB3YXRjaGVyPzogV2F0Y2hPcHRpb25zXG4gICAgcm91dGVyOiBSb3V0ZXIuQ29uZmlnPEhUVFBWZXJzaW9uLlYxIHwgSFRUUFZlcnNpb24uVjI+XG4gICAgbWlkZGxld2FyZTogRmluZE15V2F5TWlkZGxld2FyZVtdXG4gICAgcHJveHk6IHsgW3BhdGg6IHN0cmluZ106IFNlcnZlci5TZXJ2ZXJPcHRpb25zIH1cbiAgICBjb3JzOiBDb3JzT3B0aW9uc1xuICAgIGV0YWc6IE9wdGlvbnNcbiAgICBjYWNoZT86IGJvb2xlYW5cbiAgICBlbmNvZGluZzogXCJnemlwXCIgfCBcImJyb3RsaVwiIHwgXCJiclwiIHwgXCJkZWZsYXRlXCIgfCBcImRlZmxhdGUtcmF3XCIgfCB1bmRlZmluZWRcbiAgICB0cmFuc2Zvcm06IHtcbiAgICAgICAgaW5jbHVkZTogc3RyaW5nIHwgc3RyaW5nW11cbiAgICAgICAgZXhjbHVkZTogc3RyaW5nIHwgc3RyaW5nW11cbiAgICAgICAgcHJlUHJvY2Vzcz8oZmlsZW5hbWU6IHN0cmluZywgY29kZTogc3RyaW5nKTogc3RyaW5nXG4gICAgfVxuICAgIG1vdW50OiB7IFtwYXRoOiBzdHJpbmddOiBzdHJpbmcgfVxuICAgIGJhYmVsOiBUcmFuc2Zvcm1PcHRpb25zXG4gICAgc2FzczogU3luY09wdGlvbnNcbiAgICBtZXNzYWdpbmc/OiBNZXNzYWdpbmdPcHRpb25zXG4gICAgcGx1Z2luczogKE1vZGVybm9PcHRpb25zfHN0cmluZylbXVxufVxuXG5mdW5jdGlvbiBsb2FkQ29uZmlnKHBhdGhuYW1lOiBzdHJpbmcpOiBzdHJpbmcge1xuICAgIHRyeSB7XG4gICAgICAgIGxldCBjb25maWcgPSByZXF1aXJlKHBhdGgucmVzb2x2ZShwYXRobmFtZSkpO1xuICAgICAgICBpZiAoY29uZmlnLmV4dGVuZHMpIHtcbiAgICAgICAgICAgIGNvbnN0IGJhc2UgPSBjb25maWcuZXh0ZW5kcztcbiAgICAgICAgICAgIGRlbGV0ZSBjb25maWcuZXh0ZW5kcztcbiAgICAgICAgICAgIGNvbmZpZyA9IGFzc2lnbkNvbmZpZyhiYXNlLCBjb25maWcpO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiBjb25maWc7XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgICAgbG9nLmVycm9yKGBVbmFibGUgdG8gbG9hZCBjb25maWcgJyR7cGF0aG5hbWV9JyBmcm9tICcke3Byb2Nlc3MuY3dkKCl9J1xcbmAsIGVycm9yKTtcbiAgICAgICAgcHJvY2Vzcy5leGl0KDEpO1xuICAgIH1cbn1cblxuZnVuY3Rpb24gcmVzb2x2ZUNvbmZpZyhwYXRobmFtZTogc3RyaW5nKTogc3RyaW5nIHwgbnVsbCB7XG4gICAgdHJ5IHtcbiAgICAgICAgcmV0dXJuIHJlcXVpcmUucmVzb2x2ZShwYXRoLnJlc29sdmUocGF0aG5hbWUpKTtcbiAgICB9IGNhdGNoIChpZ25vcmVkKSB7XG4gICAgICAgIHJldHVybiBudWxsO1xuICAgIH1cbn1cblxuZnVuY3Rpb24gYXNzaWduQ29uZmlnPFY+KHRhcmdldDogViwgc291cmNlOiBhbnkpIHtcbiAgICBpZiAoc291cmNlICE9PSB1bmRlZmluZWQgJiYgc291cmNlICE9PSBudWxsKSB7XG4gICAgICAgIGlmICh0YXJnZXQgaW5zdGFuY2VvZiBBcnJheSAmJiBzb3VyY2UgaW5zdGFuY2VvZiBBcnJheSkge1xuICAgICAgICAgICAgY29uc3QgbWVyZ2VkID0gbmV3IFNldCh0YXJnZXQpO1xuICAgICAgICAgICAgZm9yIChjb25zdCBpdGVtIG9mIHNvdXJjZSkge1xuICAgICAgICAgICAgICAgIG1lcmdlZC5hZGQoaXRlbSk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICB0YXJnZXQubGVuZ3RoID0gMDtcbiAgICAgICAgICAgIHRhcmdldC5wdXNoKC4uLm1lcmdlZCk7XG4gICAgICAgIH0gZWxzZSBpZiAodGFyZ2V0IGluc3RhbmNlb2YgT2JqZWN0ICYmIHNvdXJjZSBpbnN0YW5jZW9mIE9iamVjdCkge1xuICAgICAgICAgICAgZm9yIChjb25zdCBbaywgdl0gb2YgT2JqZWN0LmVudHJpZXM8b2JqZWN0Pihzb3VyY2UpKSB7XG4gICAgICAgICAgICAgICAgaWYgKHRhcmdldFtrXSAmJiAodi5jb25zdHJ1Y3RvciA9PT0gT2JqZWN0IHx8IHYuY29uc3RydWN0b3IgPT09IEFycmF5KSkge1xuICAgICAgICAgICAgICAgICAgICBhc3NpZ25Db25maWcodGFyZ2V0W2tdLCB2KTtcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICB0YXJnZXRba10gPSB2O1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgIH1cbn1cblxuZnVuY3Rpb24gc3RhdERpcmVjdG9yeShwYXRobmFtZSkge1xuICAgIHRyeSB7XG4gICAgICAgIHJldHVybiBmcy5zdGF0U3luYyhwYXRobmFtZSk7XG4gICAgfSBjYXRjaCAoaWdub3JlZCkge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYEVOT0VOVDogbm8gc3VjaCBmaWxlIG9yIGRpcmVjdG9yeSAnJHtwYXRobmFtZX0nYCk7XG4gICAgfVxufVxuXG5mdW5jdGlvbiByZXNvbHZlRGlyZWN0b3J5KG5hbWUpIHtcbiAgICBjb25zdCBwYXRobmFtZSA9IHBhdGgucmVzb2x2ZShuYW1lKTtcbiAgICBpZiAoIXN0YXREaXJlY3RvcnkocGF0aG5hbWUpLmlzRGlyZWN0b3J5KCkpIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBFTk9ESVI6IG5vdCBhIGRpcmVjdG9yeSAnJHtwYXRobmFtZX0nYCk7XG4gICAgfVxuICAgIHJldHVybiBwYXRobmFtZTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGRlZmF1bHRPcHRpb25zKGFyZ3M6IEFyZ3MpOiBNb2Rlcm5vT3B0aW9ucyB7XG5cbiAgICBjb25zdCBiYXNlRGlyID0gcGF0aC5yZXNvbHZlKF9fZGlybmFtZSwgXCIuLlwiKTtcbiAgICBjb25zdCByb290RGlyID0gYXJncy5yb290ID8gcmVzb2x2ZURpcmVjdG9yeShhcmdzLnJvb3QpIDogcHJvY2Vzcy5jd2QoKTtcblxuICAgIGNvbnN0IHJlYWRUZXh0RmlsZVN5bmMgPSAoZmlsZW5hbWUpID0+IHtcbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgIHJldHVybiBmcy5yZWFkRmlsZVN5bmMocGF0aC5yZXNvbHZlKHJvb3REaXIsIGZpbGVuYW1lKSwgXCJ1dGYtOFwiKTtcbiAgICAgICAgfSBjYXRjaCAoaWdub3JlZCkge1xuICAgICAgICAgICAgcmV0dXJuIGZzLnJlYWRGaWxlU3luYyhwYXRoLnJlc29sdmUoYmFzZURpciwgZmlsZW5hbWUpLCBcInV0Zi04XCIpO1xuICAgICAgICB9XG4gICAgfTtcblxuICAgIHJldHVybiBPYmplY3QuYXNzaWduKHtcbiAgICAgICAgcm9vdERpcixcbiAgICAgICAgbG9nOiB7XG4gICAgICAgICAgICBsZXZlbDogXCJpbmZvXCJcbiAgICAgICAgfSxcbiAgICAgICAgaHR0cDI6IFwicHVzaFwiLFxuICAgICAgICBzZXJ2ZXI6IHtcbiAgICAgICAgICAgIHByb3RvY29sOiBcImh0dHBzXCIsXG4gICAgICAgICAgICBob3N0OiBcImxvY2FsaG9zdFwiLFxuICAgICAgICAgICAgcG9ydDogMzAwMCxcbiAgICAgICAgICAgIG9wdGlvbnM6IHtcbiAgICAgICAgICAgICAgICBnZXQga2V5KCkge1xuICAgICAgICAgICAgICAgICAgICByZXR1cm4gcmVhZFRleHRGaWxlU3luYyhcImNlcnQvbG9jYWxob3N0LmtleVwiKTtcbiAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICAgIGdldCBjZXJ0KCkge1xuICAgICAgICAgICAgICAgICAgICByZXR1cm4gcmVhZFRleHRGaWxlU3luYyhcImNlcnQvbG9jYWxob3N0LmNydFwiKTtcbiAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICAgIGFsbG93SFRUUDE6IHRydWVcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSxcbiAgICAgICAgcmVzb3VyY2VzOiBwYXRoLnJlc29sdmUoYmFzZURpciwgXCJyZXNvdXJjZXNcIiksXG4gICAgICAgIHdhdGNoZXI6IHtcbiAgICAgICAgICAgIGN3ZDogcm9vdERpcixcbiAgICAgICAgICAgIGF0b21pYzogZmFsc2UsXG4gICAgICAgICAgICBpZ25vcmVkOiBbXG4gICAgICAgICAgICAgICAgXCJub2RlX21vZHVsZXMvKipcIixcbiAgICAgICAgICAgICAgICBcIndlYl9tb2R1bGVzLyoqXCJcbiAgICAgICAgICAgIF1cbiAgICAgICAgfSxcbiAgICAgICAgcm91dGVyOiB7XG4gICAgICAgICAgICBpZ25vcmVUcmFpbGluZ1NsYXNoOiB0cnVlLFxuICAgICAgICAgICAgYWxsb3dVbnNhZmVSZWdleDogdHJ1ZVxuICAgICAgICB9LFxuICAgICAgICBtaWRkbGV3YXJlOiBbXSxcbiAgICAgICAgcHJveHk6IHtcbiAgICAgICAgICAgIFwiL2FwaVwiOiB7dGFyZ2V0OiBcImh0dHA6Ly9sb2NhbGhvc3Q6OTAwMFwifVxuICAgICAgICB9LFxuICAgICAgICBjb3JzOiB7XG4gICAgICAgICAgICBvcmlnaW46IFwiKlwiLFxuICAgICAgICAgICAgbWV0aG9kczogXCJHRVQsIEhFQUQsIFBVVCwgUE9TVCwgREVMRVRFLCBQQVRDSFwiLFxuICAgICAgICAgICAgYWxsb3dlZEhlYWRlcnM6IFwiWC1SZXF1ZXN0ZWQtV2l0aCwgQWNjZXB0LCBDb250ZW50LVR5cGVcIixcbiAgICAgICAgICAgIGNyZWRlbnRpYWxzOiB0cnVlXG4gICAgICAgIH0sXG4gICAgICAgIGNhY2hlOiB0cnVlLFxuICAgICAgICBkZWZsYXRlOiB0cnVlLFxuICAgICAgICBldGFnOiB7XG4gICAgICAgICAgICB3ZWFrOiBmYWxzZVxuICAgICAgICB9LFxuICAgICAgICBtb3VudDoge1xuICAgICAgICAgICAgXCIvXCI6IHJvb3REaXJcbiAgICAgICAgfSxcbiAgICAgICAgYmFiZWw6IHtcbiAgICAgICAgICAgIGJhYmVscmM6IHRydWUsXG4gICAgICAgICAgICBjYWxsZXI6IHtcbiAgICAgICAgICAgICAgICBuYW1lOiBcIkBtb2Rlcm5vL3NlcnZlclwiLFxuICAgICAgICAgICAgICAgIHN1cHBvcnRzU3RhdGljRVNNOiB0cnVlXG4gICAgICAgICAgICB9LFxuICAgICAgICAgICAgc291cmNlVHlwZTogXCJtb2R1bGVcIixcbiAgICAgICAgICAgIHNvdXJjZU1hcHM6IHRydWUsXG4gICAgICAgICAgICBwbHVnaW5zOiBbXG4gICAgICAgICAgICAgICAgW1wiQGJhYmVsL3BsdWdpbi1zeW50YXgtaW1wb3J0LW1ldGFcIl0sXG4gICAgICAgICAgICAgICAgW1wiQGJhYmVsL3BsdWdpbi10cmFuc2Zvcm0tcnVudGltZVwiLCB7XG4gICAgICAgICAgICAgICAgICAgIFwiY29yZWpzXCI6IGZhbHNlLFxuICAgICAgICAgICAgICAgICAgICBcImhlbHBlcnNcIjogdHJ1ZSxcbiAgICAgICAgICAgICAgICAgICAgXCJyZWdlbmVyYXRvclwiOiBmYWxzZSxcbiAgICAgICAgICAgICAgICAgICAgXCJ1c2VFU01vZHVsZXNcIjogdHJ1ZSxcbiAgICAgICAgICAgICAgICAgICAgXCJhYnNvbHV0ZVJ1bnRpbWVcIjogZmFsc2UsXG4gICAgICAgICAgICAgICAgICAgIFwidmVyc2lvblwiOiBcIjcuMTAuNVwiXG4gICAgICAgICAgICAgICAgfV1cbiAgICAgICAgICAgIF1cbiAgICAgICAgfSxcbiAgICAgICAgc2Fzczoge1xuICAgICAgICAgICAgZXh0ZW5zaW9uczogW1wiLnNjc3NcIiwgXCIuY3NzXCIsIFwiLnNhc3NcIl0sXG4gICAgICAgICAgICBvdXRwdXRTdHlsZTogXCJleHBhbmRlZFwiXG4gICAgICAgIH1cbiAgICB9LCByZXF1aXJlKFwiQG1vZGVybm8vd2ViLW1vZHVsZXMvd2ViLW1vZHVsZXMuY29uZmlnLmpzXCIpKTtcbn1cblxuZXhwb3J0IHR5cGUgQXJncyA9IHtcbiAgICBjb25maWc/OiBzdHJpbmdcbiAgICByb290Pzogc3RyaW5nXG4gICAgcGx1Z2luPzogc3RyaW5nIHwgc3RyaW5nW11cbiAgICBkZWJ1Zz86IGJvb2xlYW5cbiAgICBwcm9kdWN0aW9uPzogYm9vbGVhblxufVxuXG5leHBvcnQgZnVuY3Rpb24gY29uZmlndXJlKGFyZ3M6IEFyZ3MgPSB7fSwgb3ZlcnJpZGU/KTogUmVhZG9ubHk8TW9kZXJub09wdGlvbnM+IHtcblxuICAgIGxldCBvcHRpb25zOiBNb2Rlcm5vT3B0aW9ucyA9IGRlZmF1bHRPcHRpb25zKGFyZ3MpO1xuXG4gICAgaWYgKGFyZ3MuY29uZmlnKSB7XG4gICAgICAgIGFzc2lnbkNvbmZpZyhvcHRpb25zLCBsb2FkQ29uZmlnKGFyZ3MuY29uZmlnKSk7XG4gICAgfSBlbHNlIHtcbiAgICAgICAgY29uc3Qgcm9vdENvbmZpZyA9IHJlc29sdmVDb25maWcocGF0aC5qb2luKG9wdGlvbnMucm9vdERpciwgXCJtb2Rlcm5vLmNvbmZpZ1wiKSk7XG4gICAgICAgIGNvbnN0IGxvY2FsQ29uZmlnID0gcmVzb2x2ZUNvbmZpZyhcIm1vZGVybm8uY29uZmlnXCIpO1xuICAgICAgICBpZiAocm9vdENvbmZpZykge1xuICAgICAgICAgICAgaWYgKGxvY2FsQ29uZmlnICE9PSByb290Q29uZmlnKSB7XG4gICAgICAgICAgICAgICAgYXNzaWduQ29uZmlnKG9wdGlvbnMsIGxvYWRDb25maWcocm9vdENvbmZpZykpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgbG9nLmRlYnVnKGBubyBjb25maWcgZm91bmQgaW4gJyR7b3B0aW9ucy5yb290RGlyfSdgKTtcbiAgICAgICAgfVxuICAgICAgICBpZiAobG9jYWxDb25maWcpIHtcbiAgICAgICAgICAgIGFzc2lnbkNvbmZpZyhvcHRpb25zLCBsb2FkQ29uZmlnKGxvY2FsQ29uZmlnKSk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBsb2cuZGVidWcoYG5vIGNvbmZpZyBmb3VuZCBpbiAnJHtwcm9jZXNzLmN3ZCgpfSdgKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIGlmIChvdmVycmlkZSkge1xuICAgICAgICBhc3NpZ25Db25maWcob3B0aW9ucywgb3ZlcnJpZGUpO1xuICAgIH1cblxuICAgIGNvbnN0IHBsdWdpbnMgPSBvcHRpb25zLnBsdWdpbnMgfHwgW107XG5cbiAgICBpZiAoYXJncy5wbHVnaW4pIHtcbiAgICAgICAgY29uc3QgbmFtZXMgPSBBcnJheS5pc0FycmF5KGFyZ3MucGx1Z2luKSA/IGFyZ3MucGx1Z2luIDogW2FyZ3MucGx1Z2luXTtcbiAgICAgICAgZm9yIChjb25zdCBuYW1lIG9mIG5hbWVzKSB0cnkge1xuICAgICAgICAgICAgcGx1Z2lucy5wdXNoKHJlcXVpcmUucmVzb2x2ZShuYW1lLCB7cGF0aHM6IFtvcHRpb25zLnJvb3REaXJdfSkpO1xuICAgICAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgICAgICBwbHVnaW5zLnB1c2gocmVxdWlyZS5yZXNvbHZlKG5hbWUsIHtwYXRoczogW19fZGlybmFtZV19KSk7XG4gICAgICAgICAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgICAgICAgICAgIGxvZy5lcnJvcihcInBsdWdpbiAnXCIgKyBuYW1lICsgXCInIHJlc29sdXRpb24gZmFpbGVkOlwiLCBlcnJvcik7XG4gICAgICAgICAgICAgICAgcHJvY2Vzcy5leGl0KDEpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgfVxuXG4gICAgZm9yIChsZXQgcGx1Z2luIG9mIHBsdWdpbnMpIHRyeSB7XG4gICAgICAgIGlmICh0eXBlb2YgcGx1Z2luID09PSBcInN0cmluZ1wiKSB7XG4gICAgICAgICAgICBwbHVnaW4gPSByZXF1aXJlKHBsdWdpbikgYXMgTW9kZXJub09wdGlvbnM7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKHBsdWdpbi5leHRlbmRzKSB7XG4gICAgICAgICAgICBhc3NpZ25Db25maWcocGx1Z2luLmV4dGVuZHMsIHBsdWdpbik7XG4gICAgICAgICAgICBwbHVnaW4gPSBwbHVnaW4uZXh0ZW5kcztcbiAgICAgICAgICAgIGRlbGV0ZSBwbHVnaW4uZXh0ZW5kcztcbiAgICAgICAgfVxuICAgICAgICBhc3NpZ25Db25maWcob3B0aW9ucywgcGx1Z2luKTtcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgICBsb2cuZXJyb3IoXCJwbHVnaW4gJ1wiICsgcGx1Z2luICsgXCInIGxvYWRpbmcgZmFpbGVkOlwiLCBlcnJvcik7XG4gICAgICAgIHByb2Nlc3MuZXhpdCgxKTtcbiAgICB9XG5cbiAgICBpZiAob3B0aW9ucy5sb2cpIHtcbiAgICAgICAgT2JqZWN0LmFzc2lnbihsb2csIG9wdGlvbnMubG9nKTtcbiAgICB9XG5cbiAgICBpZiAoYXJncy5kZWJ1Zykge1xuICAgICAgICBsb2cubGV2ZWwgPSBcImRlYnVnXCI7XG4gICAgfVxuXG4gICAgbG9nLmRlYnVnKFwiY29uZmlndXJlZDpcIiwgb3B0aW9ucyk7XG5cbiAgICByZXR1cm4gb3B0aW9ucztcbn1cbiJdfQ==