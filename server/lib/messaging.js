"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.useMessaging = void 0;
const chalk_1 = __importDefault(require("chalk"));
const web_modules_1 = require("@moderno/web-modules");
const nano_memoize_1 = __importDefault(require("nano-memoize"));
const logger_1 = __importDefault(require("@moderno/logger"));
const ws_1 = __importDefault(require("ws"));
const multi_map_1 = require("./util/multi-map");
const watcher_1 = require("./watcher");
exports.useMessaging = nano_memoize_1.default((options) => {
    var _a, _b;
    const sockets = new Set();
    function broadcast(type, data) {
        const message = data === undefined ? type : JSON.stringify({ type, data });
        for (const ws of sockets) {
            ws.send(message);
        }
    }
    const callbacks = new multi_map_1.MultiMap();
    function on(type, cb) {
        callbacks.add(type, cb);
        logger_1.default.debug("added message listener for:", chalk_1.default.magenta(type));
    }
    const watcher = watcher_1.useWatcher(options);
    for (const plugin of (_b = (_a = options.messaging) === null || _a === void 0 ? void 0 : _a.plugins) !== null && _b !== void 0 ? _b : []) {
        plugin({ on, broadcast, options, watcher });
    }
    function openCallback(ws) {
        function send(type, data) {
            const message = data === undefined ? type : JSON.stringify({ type, data });
            return ws.send(message);
        }
        logger_1.default.debug("client connected:", ws.url);
        sockets.add(ws);
        ws.on("error", () => {
            logger_1.default.debug("client error:", ws.url);
        });
        ws.on("close", () => {
            logger_1.default.debug("client disconnected:", ws.url);
            sockets.delete(ws);
        });
        ws.on("message", function (message) {
            const { type, data } = message[0] === "{" ? JSON.parse(message) : { type: message };
            if (callbacks.has(type))
                for (const callback of callbacks.get(type)) {
                    callback(data, send);
                }
        });
        ws.send(JSON.stringify({ type: "hello", data: { time: new Date().toUTCString() } }));
    }
    function errorCallback(error) {
        logger_1.default.error("websocket error:", error);
    }
    function closeCallback() {
        logger_1.default.info("websocket closed");
    }
    web_modules_1.notifications.on("create", (notification) => {
        broadcast("notification:new", notification);
    });
    web_modules_1.notifications.on("update", (notification) => {
        broadcast("notification:update", notification);
    });
    return {
        handleUpgrade(req, socket, head) {
            if (req.headers["sec-websocket-protocol"] === "esnext-dev") {
                const wss = new ws_1.default.Server({ noServer: true });
                wss.on("open", openCallback);
                wss.on("error", errorCallback);
                wss.on("close", closeCallback);
                wss.handleUpgrade(req, socket, head, client => wss.emit("open", client, req));
                logger_1.default.info("websocket ready");
            }
        },
        broadcast
    };
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibWVzc2FnaW5nLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vc3JjL21lc3NhZ2luZy50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7QUFBQSxrREFBMEI7QUFFMUIsc0RBQTJFO0FBQzNFLGdFQUFvQztBQUNwQyw2REFBa0M7QUFDbEMsNENBQTJCO0FBRTNCLGdEQUEwQztBQUMxQyx1Q0FBcUM7QUFZeEIsUUFBQSxZQUFZLEdBQUcsc0JBQVEsQ0FBQyxDQUFDLE9BQXVCLEVBQUUsRUFBRTs7SUFFN0QsTUFBTSxPQUFPLEdBQUcsSUFBSSxHQUFHLEVBQWEsQ0FBQztJQUVyQyxTQUFTLFNBQVMsQ0FBQyxJQUFZLEVBQUUsSUFBVTtRQUN2QyxNQUFNLE9BQU8sR0FBRyxJQUFJLEtBQUssU0FBUyxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsRUFBQyxJQUFJLEVBQUUsSUFBSSxFQUFDLENBQUMsQ0FBQztRQUN6RSxLQUFLLE1BQU0sRUFBRSxJQUFJLE9BQU8sRUFBRTtZQUN0QixFQUFFLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxDQUFDO1NBQ3BCO0lBQ0wsQ0FBQztJQUVELE1BQU0sU0FBUyxHQUFHLElBQUksb0JBQVEsRUFBMkIsQ0FBQztJQUUxRCxTQUFTLEVBQUUsQ0FBQyxJQUFZLEVBQUUsRUFBbUI7UUFDekMsU0FBUyxDQUFDLEdBQUcsQ0FBQyxJQUFJLEVBQUUsRUFBRSxDQUFDLENBQUM7UUFDeEIsZ0JBQUcsQ0FBQyxLQUFLLENBQUMsNkJBQTZCLEVBQUUsZUFBSyxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDO0lBQ2xFLENBQUM7SUFFRCxNQUFNLE9BQU8sR0FBRyxvQkFBVSxDQUFDLE9BQU8sQ0FBQyxDQUFDO0lBRXBDLEtBQUssTUFBTSxNQUFNLElBQUksTUFBQSxNQUFBLE9BQU8sQ0FBQyxTQUFTLDBDQUFFLE9BQU8sbUNBQUksRUFBRSxFQUFFO1FB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QVMsQ0FBQyxNQUFNLENBQUMsRUFBQyxRQUFRLEVBQUUsSUFBSSxFQUFDLENBQUMsQ0FBQztnQkFDbkQsR0FBRyxDQUFDLEVBQUUsQ0FBQyxNQUFNLEVBQUUsWUFBWSxDQUFDLENBQUM7Z0JBQzdCLEdBQUcsQ0FBQyxFQUFFLENBQUMsT0FBTyxFQUFFLGFBQWEsQ0FBQyxDQUFDO2dCQUMvQixHQUFHLENBQUMsRUFBRSxDQUFDLE9BQU8sRUFBRSxhQUFhLENBQUMsQ0FBQztnQkFDL0IsR0FBRyxDQUFDLGFBQWEsQ0FBQyxHQUFHLEVBQUUsTUFBTSxFQUFFLElBQUksRUFBRSxNQUFNLENBQUMsRUFBRSxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsTUFBTSxFQUFFLE1BQU0sRUFBRSxHQUFHLENBQUMsQ0FBQyxDQUFDO2dCQUM5RSxnQkFBRyxDQUFDLElBQUksQ0FBQyxpQkFBaUIsQ0FBQyxDQUFDO2FBQy9CO1FBQ0wsQ0FBQztRQUNELFNBQVM7S0FDWixDQUFDO0FBQ04sQ0FBQyxDQUFDLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgY2hhbGsgZnJvbSBcImNoYWxrXCI7XHJcbmltcG9ydCB7RlNXYXRjaGVyfSBmcm9tIFwiY2hva2lkYXJcIjtcclxuaW1wb3J0IHtub3RpZmljYXRpb25zLCBXZWJNb2R1bGVzTm90aWZpY2F0aW9ufSBmcm9tIFwiQG1vZGVybm8vd2ViLW1vZHVsZXNcIjtcclxuaW1wb3J0IG1lbW9pemVkIGZyb20gXCJuYW5vLW1lbW9pemVcIjtcclxuaW1wb3J0IGxvZyBmcm9tIFwiQG1vZGVybm8vbG9nZ2VyXCI7XHJcbmltcG9ydCBXZWJTb2NrZXQgZnJvbSBcIndzXCI7XHJcbmltcG9ydCB7TW9kZXJub09wdGlvbnN9IGZyb20gXCIuL2NvbmZpZ3VyZVwiO1xyXG5pbXBvcnQge011bHRpTWFwfSBmcm9tIFwiLi91dGlsL211bHRpLW1hcFwiO1xyXG5pbXBvcnQge3VzZVdhdGNoZXJ9IGZyb20gXCIuL3dhdGNoZXJcIjtcclxuXHJcbmV4cG9ydCB0eXBlIE1lc3NhZ2UgPSB7IHR5cGU6IHN0cmluZywgZGF0YT86IGFueSB9O1xyXG5leHBvcnQgdHlwZSBTZW5kTWVzc2FnZSA9ICh0eXBlOiBzdHJpbmcsIGRhdGE/OiBhbnkpID0+IHZvaWQ7XHJcbmV4cG9ydCB0eXBlIE1lc3NhZ2VDYWxsYmFjayA9IChkYXRhOiBhbnksIHNlbmQ6IFNlbmRNZXNzYWdlKSA9PiB2b2lkO1xyXG5leHBvcnQgdHlwZSBPbk1lc3NhZ2UgPSAodHlwZTogc3RyaW5nLCBjYjogTWVzc2FnZUNhbGxiYWNrKSA9PiB2b2lkO1xyXG5leHBvcnQgdHlwZSBNZXNzYWdpbmdDb250ZXh0ID0geyBvbjogT25NZXNzYWdlLCBicm9hZGNhc3Q6IFNlbmRNZXNzYWdlLCBvcHRpb25zOiBNb2Rlcm5vT3B0aW9ucywgd2F0Y2hlcjogRlNXYXRjaGVyIH07XHJcbmV4cG9ydCB0eXBlIE1lc3NhZ2luZ0VuZHBvaW50ID0gKG1lc3NhZ2luZ0NvbnRleHQ6IE1lc3NhZ2luZ0NvbnRleHQpID0+IHZvaWQ7XHJcbmV4cG9ydCB0eXBlIE1lc3NhZ2luZ09wdGlvbnMgPSB7XHJcbiAgICBwbHVnaW5zPzogKE1lc3NhZ2luZ0VuZHBvaW50KVtdXHJcbn1cclxuXHJcbmV4cG9ydCBjb25zdCB1c2VNZXNzYWdpbmcgPSBtZW1vaXplZCgob3B0aW9uczogTW9kZXJub09wdGlvbnMpID0+IHtcclxuXHJcbiAgICBjb25zdCBzb2NrZXRzID0gbmV3IFNldDxXZWJTb2NrZXQ+KCk7XHJcblxyXG4gICAgZnVuY3Rpb24gYnJvYWRjYXN0KHR5cGU6IHN0cmluZywgZGF0YT86IGFueSkge1xyXG4gICAgICAgIGNvbnN0IG1lc3NhZ2UgPSBkYXRhID09PSB1bmRlZmluZWQgPyB0eXBlIDogSlNPTi5zdHJpbmdpZnkoe3R5cGUsIGRhdGF9KTtcclxuICAgICAgICBmb3IgKGNvbnN0IHdzIG9mIHNvY2tldHMpIHtcclxuICAgICAgICAgICAgd3Muc2VuZChtZXNzYWdlKTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgY29uc3QgY2FsbGJhY2tzID0gbmV3IE11bHRpTWFwPHN0cmluZywgTWVzc2FnZUNhbGxiYWNrPigpO1xyXG5cclxuICAgIGZ1bmN0aW9uIG9uKHR5cGU6IHN0cmluZywgY2I6IE1lc3NhZ2VDYWxsYmFjaykge1xyXG4gICAgICAgIGNhbGxiYWNrcy5hZGQodHlwZSwgY2IpO1xyXG4gICAgICAgIGxvZy5kZWJ1ZyhcImFkZGVkIG1lc3NhZ2UgbGlzdGVuZXIgZm9yOlwiLCBjaGFsay5tYWdlbnRhKHR5cGUpKTtcclxuICAgIH1cclxuXHJcbiAgICBjb25zdCB3YXRjaGVyID0gdXNlV2F0Y2hlcihvcHRpb25zKTtcclxuXHJcbiAgICBmb3IgKGNvbnN0IHBsdWdpbiBvZiBvcHRpb25zLm1lc3NhZ2luZz8ucGx1Z2lucyA/PyBbXSkge1xyXG4gICAgICAgIHBsdWdpbih7b24sIGJyb2FkY2FzdCwgb3B0aW9ucywgd2F0Y2hlcn0pO1xyXG4gICAgfVxyXG5cclxuICAgIGZ1bmN0aW9uIG9wZW5DYWxsYmFjayh3czogV2ViU29ja2V0KSB7XHJcblxyXG4gICAgICAgIGZ1bmN0aW9uIHNlbmQodHlwZTogc3RyaW5nLCBkYXRhPzogYW55KSB7XHJcbiAgICAgICAgICAgIGNvbnN0IG1lc3NhZ2UgPSBkYXRhID09PSB1bmRlZmluZWQgPyB0eXBlIDogSlNPTi5zdHJpbmdpZnkoe3R5cGUsIGRhdGF9KTtcclxuICAgICAgICAgICAgcmV0dXJuIHdzLnNlbmQobWVzc2FnZSk7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBsb2cuZGVidWcoXCJjbGllbnQgY29ubmVjdGVkOlwiLCB3cy51cmwpO1xyXG4gICAgICAgIHNvY2tldHMuYWRkKHdzKTtcclxuXHJcbiAgICAgICAgd3Mub24oXCJlcnJvclwiLCAoKSA9PiB7XHJcbiAgICAgICAgICAgIGxvZy5kZWJ1ZyhcImNsaWVudCBlcnJvcjpcIiwgd3MudXJsKTtcclxuICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgd3Mub24oXCJjbG9zZVwiLCAoKSA9PiB7XHJcbiAgICAgICAgICAgIGxvZy5kZWJ1ZyhcImNsaWVudCBkaXNjb25uZWN0ZWQ6XCIsIHdzLnVybCk7XHJcbiAgICAgICAgICAgIHNvY2tldHMuZGVsZXRlKHdzKTtcclxuICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgd3Mub24oXCJtZXNzYWdlXCIsIGZ1bmN0aW9uIChtZXNzYWdlOiBzdHJpbmcpIHtcclxuICAgICAgICAgICAgY29uc3Qge3R5cGUsIGRhdGF9OiBNZXNzYWdlID0gbWVzc2FnZVswXSA9PT0gXCJ7XCIgPyBKU09OLnBhcnNlKG1lc3NhZ2UpIDoge3R5cGU6IG1lc3NhZ2V9O1xyXG4gICAgICAgICAgICBpZiAoY2FsbGJhY2tzLmhhcyh0eXBlKSkgZm9yIChjb25zdCBjYWxsYmFjayBvZiBjYWxsYmFja3MuZ2V0KHR5cGUpISkge1xyXG4gICAgICAgICAgICAgICAgY2FsbGJhY2soZGF0YSwgc2VuZCk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgd3Muc2VuZChKU09OLnN0cmluZ2lmeSh7dHlwZTogXCJoZWxsb1wiLCBkYXRhOiB7dGltZTogbmV3IERhdGUoKS50b1VUQ1N0cmluZygpfX0pKTtcclxuICAgIH1cclxuXHJcbiAgICBmdW5jdGlvbiBlcnJvckNhbGxiYWNrKGVycm9yKSB7XHJcbiAgICAgICAgbG9nLmVycm9yKFwid2Vic29ja2V0IGVycm9yOlwiLCBlcnJvcik7XHJcbiAgICB9XHJcblxyXG4gICAgZnVuY3Rpb24gY2xvc2VDYWxsYmFjaygpIHtcclxuICAgICAgICBsb2cuaW5mbyhcIndlYnNvY2tldCBjbG9zZWRcIik7XHJcbiAgICB9XHJcblxyXG4gICAgbm90aWZpY2F0aW9ucy5vbihcImNyZWF0ZVwiLCAobm90aWZpY2F0aW9uOiBXZWJNb2R1bGVzTm90aWZpY2F0aW9uKSA9PiB7XHJcbiAgICAgICAgYnJvYWRjYXN0KFwibm90aWZpY2F0aW9uOm5ld1wiLCBub3RpZmljYXRpb24pO1xyXG4gICAgfSk7XHJcblxyXG4gICAgbm90aWZpY2F0aW9ucy5vbihcInVwZGF0ZVwiLCAobm90aWZpY2F0aW9uOiBXZWJNb2R1bGVzTm90aWZpY2F0aW9uKSA9PiB7XHJcbiAgICAgICAgYnJvYWRjYXN0KFwibm90aWZpY2F0aW9uOnVwZGF0ZVwiLCBub3RpZmljYXRpb24pO1xyXG4gICAgfSk7XHJcblxyXG4gICAgcmV0dXJuIHtcclxuICAgICAgICBoYW5kbGVVcGdyYWRlKHJlcSwgc29ja2V0LCBoZWFkKSB7XHJcbiAgICAgICAgICAgIGlmIChyZXEuaGVhZGVyc1tcInNlYy13ZWJzb2NrZXQtcHJvdG9jb2xcIl0gPT09IFwiZXNuZXh0LWRldlwiKSB7XHJcbiAgICAgICAgICAgICAgICBjb25zdCB3c3MgPSBuZXcgV2ViU29ja2V0LlNlcnZlcih7bm9TZXJ2ZXI6IHRydWV9KTtcclxuICAgICAgICAgICAgICAgIHdzcy5vbihcIm9wZW5cIiwgb3BlbkNhbGxiYWNrKTtcclxuICAgICAgICAgICAgICAgIHdzcy5vbihcImVycm9yXCIsIGVycm9yQ2FsbGJhY2spO1xyXG4gICAgICAgICAgICAgICAgd3NzLm9uKFwiY2xvc2VcIiwgY2xvc2VDYWxsYmFjayk7XHJcbiAgICAgICAgICAgICAgICB3c3MuaGFuZGxlVXBncmFkZShyZXEsIHNvY2tldCwgaGVhZCwgY2xpZW50ID0+IHdzcy5lbWl0KFwib3BlblwiLCBjbGllbnQsIHJlcSkpO1xyXG4gICAgICAgICAgICAgICAgbG9nLmluZm8oXCJ3ZWJzb2NrZXQgcmVhZHlcIik7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9LFxyXG4gICAgICAgIGJyb2FkY2FzdFxyXG4gICAgfTtcclxufSk7XHJcbiJdfQ==